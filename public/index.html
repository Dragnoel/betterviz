<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="generator" content="Hugo 0.156.0"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Dimensional Data Visualizer - Full Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f1419;
            color: #e8e8e8;
            min-height: 100vh;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
         
        .sidebar {
            width: 350px;
            background: #1a1f26;
            border-right: 1px solid #2d3640;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .sidebar.collapsed {
            width: 0;
            padding: 0;
            overflow: hidden;
            border-right: none;
        }
        
        .sidebar-content {
            width: 310px;
            opacity: 1;
            transition: opacity 0.2s ease;
        }
        
        .sidebar.collapsed .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }
        
         
        .sidebar-toggle {
            position: fixed;
            left: 350px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 60px;
            background: #1a1f26;
            border: 1px solid #2d3640;
            border-left: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 12px;
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar-toggle:hover {
            background: #232a33;
            color: #4ecdc4;
        }
        
        .sidebar-toggle .arrow {
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed + .sidebar-toggle {
            left: 0;
        }
        
        .sidebar.collapsed + .sidebar-toggle .arrow {
            transform: rotate(180deg);
        }
        
         
        .floating-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 90;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .sidebar.collapsed ~ .main-area .floating-controls {
            opacity: 1;
            pointer-events: auto;
        }
        
        .floating-btn {
            background: #1a1f26;
            border: 1px solid #2d3640;
            border-radius: 10px;
            padding: 12px 16px;
            color: #e8e8e8;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .floating-btn:hover {
            background: #232a33;
            border-color: #4ecdc4;
        }
        
        .floating-btn .icon {
            font-size: 1.1rem;
        }
        
         
        .floating-legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 31, 38, 0.95);
            border: 1px solid #2d3640;
            border-radius: 12px;
            padding: 15px;
            z-index: 90;
            max-width: 220px;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .sidebar.collapsed ~ .main-area .floating-legend {
            opacity: 1;
            pointer-events: auto;
        }
        
        .floating-legend-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .floating-legend-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1rem;
            padding: 4px;
        }
        
        .floating-legend-toggle:hover {
            color: #aaa;
        }
        
        .floating-legend.minimized {
            padding: 10px 15px;
        }
        
        .floating-legend.minimized .floating-legend-content {
            display: none;
        }
        
        .floating-legend.minimized .floating-legend-title {
            margin-bottom: 0;
        }
        
        .sidebar h1 {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 5px;
            color: #4ecdc4;
        }
        
        .sidebar .subtitle {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title-actions {
            display: flex;
            gap: 8px;
        }
        
        .section-btn {
            background: none;
            border: none;
            color: #4ecdc4;
            cursor: pointer;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .section-btn:hover {
            background: rgba(78, 205, 196, 0.2);
        }
        
         
        .file-drop {
            border: 2px dashed #3d4650;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 15px;
        }
        
        .file-drop:hover, .file-drop.dragover {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }
        
        .file-drop-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        .file-drop-text {
            font-size: 0.8rem;
            color: #888;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #4ecdc4;
            color: #0f1419;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: #3dbdb5;
        }
        
        .btn-secondary {
            background: #2d3640;
            color: #e8e8e8;
        }
        
        .btn-secondary:hover {
            background: #3d4650;
        }
        
        .btn-success {
            background: #6bcb77;
        }
        
        .btn-success:hover {
            background: #5ab868;
        }
        
        .btn-warning {
            background: #ffd93d;
            color: #0f1419;
        }
        
        .btn-warning:hover {
            background: #f0ca2e;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.75rem;
            width: auto;
            margin-top: 0;
        }
        
         
        .changes-indicator {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            display: none;
        }
        
        .changes-indicator.visible {
            display: block;
        }
        
        .changes-count {
            font-size: 0.9rem;
            font-weight: 600;
            color: #ff6b6b;
            margin-bottom: 8px;
        }
        
        .changes-actions {
            display: flex;
            gap: 8px;
        }
        
        .changes-actions .btn {
            flex: 1;
            margin-top: 0;
            padding: 8px 12px;
            font-size: 0.75rem;
        }
        
         
        .dimension-list {
            list-style: none;
        }
        
        .dimension-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: #232a33;
            border-radius: 8px;
            margin-bottom: 6px;
            gap: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .dimension-item:hover {
            background: #2a323d;
        }
        
        .dimension-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .dimension-item.drag-over {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }
        
        .dimension-item.disabled {
            opacity: 0.4;
            background: #1a1f26;
        }
        
        .dimension-item.disabled .dimension-encoding {
            display: none;
        }
        
        .drag-handle {
            color: #555;
            cursor: grab;
            font-size: 0.9rem;
            padding: 0 2px;
            user-select: none;
        }
        
        .drag-handle:hover {
            color: #888;
        }
        
        .dimension-toggle {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #4ecdc4;
        }
        
        .dimension-rank {
            width: 20px;
            height: 20px;
            background: #4ecdc4;
            color: #0f1419;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .dimension-item.disabled .dimension-rank {
            background: #3d4650;
            color: #888;
        }
        
        .dimension-info {
            flex: 1;
            min-width: 0;
        }
        
        .dimension-name {
            font-weight: 500;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .dimension-meta {
            font-size: 0.65rem;
            color: #888;
        }
        
        .dimension-encoding {
            font-size: 0.6rem;
            padding: 2px 6px;
            background: #2d3640;
            border-radius: 4px;
            color: #aaa;
            white-space: nowrap;
        }
        
        .encoding-panel-x { background: #ff6b6b33; color: #ff6b6b; }
        .encoding-panel-y { background: #ffd93d33; color: #ffd93d; }
        .encoding-inner-x { background: #6bcb7733; color: #6bcb77; }
        .encoding-inner-y { background: #4d96ff33; color: #4d96ff; }
        .encoding-color { background: #9b59b633; color: #c39bd3; }
        .encoding-shape { background: #e67e2233; color: #e67e22; }
        
         
        .legend-section {
            margin-top: 10px;
        }
        
        .legend-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.75rem;
        }
        
        .legend-swatch {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .legend-shape {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
         
        .info-box {
            background: #232a33;
            border-radius: 8px;
            padding: 10px;
            font-size: 0.75rem;
            color: #888;
            line-height: 1.5;
        }
        
        .info-box code {
            background: #1a1f26;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #4ecdc4;
        }
        
         
        .main-area {
            flex: 1;
            padding: 20px;
            overflow: auto;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .viz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2d3640;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .viz-title {
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .viz-stats {
            font-size: 0.8rem;
            color: #888;
        }
        
        .viz-actions {
            display: flex;
            gap: 10px;
        }
        
         
        .panel-grid-container {
            overflow: auto;
            padding-bottom: 40px;
        }
        
        .panel-grid {
            display: inline-grid;
            gap: 12px;
            padding: 10px;
        }
        
        .panel-row-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #888;
            padding: 6px 4px;
            background: #1a1f26;
            border-radius: 6px;
            max-height: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .panel-col-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #888;
            padding: 4px 6px;
            background: #1a1f26;
            border-radius: 6px;
            text-align: center;
            word-break: break-word;
        }
        
        .panel {
            background: #1a1f26;
            border-radius: 10px;
            padding: 10px;
            min-width: 100px;
            position: relative;
        }
        
        .panel-title {
            font-size: 0.6rem;
            color: #555;
            margin-bottom: 6px;
            text-align: center;
        }
        
         
        .inner-grid {
            display: grid;
            gap: 1px;
            background: #2d3640;
            border-radius: 6px;
            overflow: hidden;
            min-height: 60px;
        }
        
        .inner-cell {
            background: #232a33;
            position: relative;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            justify-content: flex-start;
            gap: 3px;
            padding: 6px;
            min-height: 30px;
            min-width: 30px;
            transition: all 0.2s ease;
        }
        
        .inner-cell.drop-target {
            background: rgba(78, 205, 196, 0.2);
            box-shadow: inset 0 0 0 2px #4ecdc4;
        }
        
         
        .inner-axis-label {
            font-size: 0.55rem;
            color: #555;
            text-align: center;
            padding: 2px;
            background: #1a1f26;
        }
        
        .inner-axis-label.x-header {
            border-radius: 4px 4px 0 0;
        }
        
        .inner-axis-label.y-header {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            border-radius: 0 4px 4px 0;
        }
        
        .corner-cell {
            background: #1a1f26;
        }
        
         
        .data-point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: grab;
            transition: all 0.15s ease;
            position: relative;
            border: 2px solid transparent;
            flex-shrink: 0;
        }
        
        .data-point:hover {
            transform: scale(1.4);
            z-index: 10;
            border-color: white;
        }
        
        .data-point.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .data-point.modified {
            box-shadow: 0 0 0 2px #ffd93d;
        }
        
        .data-point.has-media::after {
            content: '‚ñ∂';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 5px;
            background: #ff6b6b;
            color: white;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .data-point.shape-circle { border-radius: 50%; }
        .data-point.shape-square { border-radius: 2px; }
        .data-point.shape-diamond { 
            border-radius: 2px;
            transform: rotate(45deg);
        }
        .data-point.shape-diamond:hover {
            transform: rotate(45deg) scale(1.4);
        }
        .data-point.shape-triangle {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 12px solid currentColor;
            background: transparent !important;
        }
        
         
        .panel-axis-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 0.5rem;
            color: #666;
        }
        
        .panel-axis-label {
            background: #232a33;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
         
        .tooltip {
            position: fixed;
            background: #232a33;
            border: 1px solid #3d4650;
            border-radius: 10px;
            padding: 12px 15px;
            max-width: 280px;
            z-index: 500;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            font-size: 0.8rem;
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        .tooltip-hint {
            color: #4ecdc4;
            margin-top: 8px;
            font-size: 0.75rem;
        }
        
         
        .context-menu {
            position: fixed;
            background: #232a33;
            border: 1px solid #3d4650;
            border-radius: 10px;
            padding: 10px;
            z-index: 600;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
        }
        
        .context-menu.visible {
            display: block;
        }
        
        .context-menu-title {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .color-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        
        .color-option {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s ease;
        }
        
        .color-option:hover {
            transform: scale(1.15);
            border-color: white;
        }
        
        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
        }
        
        .context-menu-label {
            font-size: 0.75rem;
            color: #aaa;
            margin-top: 8px;
            text-align: center;
        }
        
         
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: linear-gradient(145deg, #1e1e2f, #2d2d44);
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.8) translateY(30px);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
        }
        
        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.3rem;
            font-weight: 500;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 25px;
        }
        
         
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .data-table tr {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .data-table tr:last-child {
            border-bottom: none;
        }
        
        .data-table td {
            padding: 10px 0;
            vertical-align: top;
        }
        
        .data-table td:first-child {
            color: #888;
            width: 40%;
            font-size: 0.85rem;
        }
        
        .data-table td:last-child {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .data-tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin: 2px;
        }
        
         
        .media-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .media-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .media-section-title .icon {
            font-size: 1rem;
        }
        
        .media-container {
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }
        
        .media-container img {
            width: 100%;
            display: block;
        }
        
        .media-container video {
            width: 100%;
            display: block;
            background: #000;
        }
        
        .media-container audio {
            width: 100%;
            margin-top: 10px;
        }
        
        .media-container.audio-container {
            background: linear-gradient(145deg, #232a33, #1a1f26);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .audio-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        .no-media {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
         
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 400px;
            color: #666;
            text-align: center;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .empty-state-subtext {
            font-size: 0.85rem;
            max-width: 300px;
        }
        
        .sample-data-info {
            font-size: 0.7rem;
            color: #666;
            margin-top: 6px;
            text-align: center;
        }
        
         
        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(26, 31, 38, 0.9);
            border: 1px solid #2d3640;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.7rem;
            color: #666;
            z-index: 50;
        }
        
        .keyboard-hint kbd {
            background: #2d3640;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #aaa;
        }
        
         
        .grid-info {
            background: #232a33;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 0.7rem;
            color: #888;
            margin-top: 8px;
        }
        
        .grid-info-row {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }
        
        .grid-info-label {
            color: #666;
        }
        
        .grid-info-value {
            color: #4ecdc4;
            font-weight: 500;
        }
        
         
        .edit-hint {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 8px;
            padding: 10px;
            font-size: 0.7rem;
            color: #4ecdc4;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .edit-hint strong {
            display: block;
            margin-bottom: 4px;
        }
        
        .edit-hint ul {
            margin: 6px 0 0 16px;
            padding: 0;
        }
        
        .edit-hint li {
            margin: 3px 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <h1>üìä Data Editor</h1>
                <p class="subtitle">Drag points to reclassify ‚Ä¢ Right-click to change color</p>
                
                <div class="section">
                    <div class="section-title">Data Input</div>
                    <div class="file-drop" id="fileDrop">
                        <div class="file-drop-icon">üìÅ</div>
                        <div class="file-drop-text">Drop CSV here or click</div>
                        <input type="file" class="file-input" id="fileInput" accept=".csv">
                    </div>
                    <button class="btn btn-secondary" onclick="loadSampleData()">Load Sample Data</button>
                    <div class="sample-data-info">Linguistics dataset with audio</div>
                </div>
                
                
                <div class="changes-indicator" id="changesIndicator">
                    <div class="changes-count" id="changesCount">0 changes made</div>
                    <div class="changes-actions">
                        <button class="btn btn-success btn-small" onclick="downloadCSV()">üì• Download CSV</button>
                        <button class="btn btn-warning btn-small" onclick="resetAllChanges()">‚Ü©Ô∏è Reset All</button>
                    </div>
                </div>
                
                <div class="section" id="dimensionSection" style="display: none;">
                    <div class="section-title">
                        <span>Dimensions</span>
                        <div class="section-title-actions">
                            <button class="section-btn" onclick="resetDimensionOrder()">Reset</button>
                        </div>
                    </div>
                    
                    <div class="edit-hint">
                        <strong>‚úèÔ∏è Edit Mode</strong>
                        <ul>
                            <li>Drag dimensions to reorder axes</li>
                            <li>Drag data points to reclassify</li>
                            <li>Right-click points to change color</li>
                        </ul>
                    </div>
                    
                    <ul class="dimension-list" id="dimensionList"></ul>
                    <div class="grid-info" id="gridInfo"></div>
                </div>
                
                <div class="section" id="legendSection" style="display: none;">
                    <div class="section-title">Color Legend</div>
                    <div class="legend-section" id="colorLegend"></div>
                </div>
                
                <div class="section" id="shapeLegendSection" style="display: none;">
                    <div class="section-title">Shape Legend</div>
                    <div class="legend-section" id="shapeLegend"></div>
                </div>
            </div>
        </div>
        
        
        <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar (Press B)">
            <span class="arrow">‚óÄ</span>
        </button>
        
        
        <div class="main-area">
            
            <div class="floating-controls" id="floatingControls">
                <button class="floating-btn" onclick="document.getElementById('fileInput').click()">
                    <span class="icon">üìÅ</span>
                    <span>Load CSV</span>
                </button>
                <button class="floating-btn" onclick="downloadCSV()">
                    <span class="icon">üì•</span>
                    <span>Download</span>
                </button>
            </div>
            
            
            <div class="floating-legend" id="floatingLegend">
                <button class="floating-legend-toggle" onclick="toggleFloatingLegend()">‚àí</button>
                <div class="floating-legend-title">Legend</div>
                <div class="floating-legend-content" id="floatingLegendContent"></div>
            </div>
            
            <div class="viz-header" id="vizHeader" style="display: none;">
                <div>
                    <div class="viz-title" id="vizTitle">Visualization</div>
                    <div class="viz-stats" id="vizStats"></div>
                </div>
                <div class="viz-actions">
                    <button class="btn btn-success btn-small" onclick="downloadCSV()">üì• Download CSV</button>
                </div>
            </div>
            
            <div class="panel-grid-container" id="vizContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üìà</div>
                    <div class="empty-state-text">No data loaded</div>
                    <div class="empty-state-subtext">
                        Upload a CSV file or load sample data. Drag points to reclassify them, then download the updated CSV.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <div class="keyboard-hint">
        <kbd>B</kbd> sidebar ‚Ä¢ <kbd>Right-click</kbd> change color ‚Ä¢ <kbd>Drag</kbd> reclassify
    </div>
    
    
    <div class="tooltip" id="tooltip"></div>
    
    
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-title">Change Color Value</div>
        <div class="color-grid" id="colorGrid"></div>
        <div class="context-menu-label" id="colorLabel"></div>
    </div>
    
    
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">Record Details</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
    
    <script>
        
        
        
        const COLORS = [
            '#4ecdc4', '#ff6b6b', '#ffd93d', '#6bcb77', '#4d96ff',
            '#9b59b6', '#e67e22', '#1abc9c', '#e74c3c', '#3498db'
        ];
        
        const SHAPES = ['circle', 'square', 'diamond', 'triangle'];
        
        const ENCODING_LABELS = [
            { key: 'panel-x', label: 'Panel X', class: 'encoding-panel-x' },
            { key: 'panel-y', label: 'Panel Y', class: 'encoding-panel-y' },
            { key: 'inner-x', label: 'Inner X', class: 'encoding-inner-x' },
            { key: 'inner-y', label: 'Inner Y', class: 'encoding-inner-y' },
            { key: 'color', label: 'Color', class: 'encoding-color' },
            { key: 'shape', label: 'Shape', class: 'encoding-shape' }
        ];
        
        const RESERVED_COLUMNS = ['media_type', 'media_url', 'description', 'title', 'name'];
        
        
        
        
        let originalData = null;  
        let currentData = null;   
        let allDimensions = null;
        let userDimensionOrder = [];
        let enabledDimensions = new Set();
        let encodings = null;
        let modifiedRows = new Set();  
        
        
        let draggedDimensionItem = null;
        let draggedDataPoint = null;
        let draggedRowIndex = null;
        
        
        let contextMenuRowIndex = null;
        
        
        
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            
            if (encodings) {
                updateFloatingLegend(encodings);
            }
        }
        
        function toggleFloatingLegend() {
            const legend = document.getElementById('floatingLegend');
            const btn = legend.querySelector('.floating-legend-toggle');
            legend.classList.toggle('minimized');
            btn.textContent = legend.classList.contains('minimized') ? '+' : '‚àí';
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'b' || e.key === 'B') {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    toggleSidebar();
                }
            }
            if (e.key === 'Escape') {
                closeContextMenu();
                closeModal();
            }
        });
        
        
        
        
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            const data = lines.slice(1).map((line, idx) => {
                const values = parseCSVLine(line);
                const row = { _index: idx };
                headers.forEach((header, i) => {
                    row[header] = values[i]?.trim() ?? '';
                });
                return row;
            });
            
            return { headers, data };
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        
        
        
        function generateCSV() {
            if (!currentData || currentData.length === 0) return '';
            
            
            const headers = Object.keys(currentData[0]).filter(k => !k.startsWith('_'));
            
            
            let csv = headers.join(',') + '\n';
            
            currentData.forEach(row => {
                const values = headers.map(h => {
                    let val = row[h] ?? '';
                    
                    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                        val = '"' + val.replace(/"/g, '""') + '"';
                    }
                    return val;
                });
                csv += values.join(',') + '\n';
            });
            
            return csv;
        }
        
        function downloadCSV() {
            const csv = generateCSV();
            if (!csv) {
                alert('No data to download');
                return;
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'edited_data.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        
        
        
        function updateChangesIndicator() {
            const indicator = document.getElementById('changesIndicator');
            const countEl = document.getElementById('changesCount');
            
            if (modifiedRows.size > 0) {
                indicator.classList.add('visible');
                countEl.textContent = `${modifiedRows.size} change${modifiedRows.size > 1 ? 's' : ''} made`;
            } else {
                indicator.classList.remove('visible');
            }
        }
        
        function resetAllChanges() {
            if (!originalData) return;
            
            
            currentData = JSON.parse(JSON.stringify(originalData));
            modifiedRows.clear();
            
            updateChangesIndicator();
            updateVisualization();
        }
        
        
        
        
        function analyzeDimensions(headers, data) {
            const validHeaders = headers.filter((header, idx) => {
                const headerLower = header.toLowerCase();
                
                if (RESERVED_COLUMNS.some(rc => headerLower.includes(rc))) {
                    return false;
                }
                
                const values = data.map(row => row[header]);
                const uniqueCount = new Set(values).size;
                
                const isIdColumn = (idx === 0 && headerLower.includes('id')) || 
                                   uniqueCount === data.length;
                
                return !isIdColumn;
            });
            
            const dims = validHeaders.map(header => {
                const values = data.map(row => row[header]);
                const uniqueValues = [...new Set(values)].sort();
                
                return {
                    name: header,
                    uniqueValues,
                    cardinality: uniqueValues.length
                };
            });
            
            dims.sort((a, b) => b.cardinality - a.cardinality);
            
            return dims;
        }
        
        function getActiveDimensions() {
            return userDimensionOrder
                .filter(name => enabledDimensions.has(name))
                .map(name => allDimensions.find(d => d.name === name))
                .filter(Boolean);
        }
        
        function assignEncodings(dims) {
            const encodings = {};
            
            dims.forEach((dim, idx) => {
                if (idx === 0) encodings.panelX = dim;
                else if (idx === 1) encodings.panelY = dim;
                else if (idx === 2) encodings.innerX = dim;
                else if (idx === 3) encodings.innerY = dim;
                else if (idx === 4) encodings.color = dim;
                else if (idx === 5) encodings.shape = dim;
            });
            
            return encodings;
        }
        
        
        
        
        function toggleDimension(name, enabled) {
            if (enabled) {
                enabledDimensions.add(name);
            } else {
                enabledDimensions.delete(name);
            }
            updateVisualization();
        }
        
        function resetDimensionOrder() {
            userDimensionOrder = allDimensions.map(d => d.name);
            enabledDimensions = new Set(userDimensionOrder);
            renderDimensionList();
            updateVisualization();
        }
        
        function updateVisualization() {
            const activeDims = getActiveDimensions();
            encodings = assignEncodings(activeDims);
            
            updateDimensionListEncodings();
            updateColorLegend(encodings);
            updateShapeLegend(encodings);
            updateGridInfo(encodings);
            
            if (currentData && activeDims.length > 0) {
                renderVisualization(currentData, encodings);
            } else {
                document.getElementById('vizContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-text">No dimensions enabled</div>
                        <div class="empty-state-subtext">
                            Enable at least one dimension in the sidebar.
                        </div>
                    </div>
                `;
            }
            
            updateFloatingLegend(encodings);
        }
        
        
        
        
        function handleDimDragStart(e, name) {
            draggedDimensionItem = name;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDimDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedDimensionItem = null;
            document.querySelectorAll('.dimension-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }
        
        function handleDimDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDimDragEnter(e, name) {
            if (draggedDimensionItem && draggedDimensionItem !== name) {
                e.target.closest('.dimension-item').classList.add('drag-over');
            }
        }
        
        function handleDimDragLeave(e) {
            e.target.closest('.dimension-item')?.classList.remove('drag-over');
        }
        
        function handleDimDrop(e, targetName) {
            e.preventDefault();
            if (!draggedDimensionItem || draggedDimensionItem === targetName) return;
            
            const fromIndex = userDimensionOrder.indexOf(draggedDimensionItem);
            const toIndex = userDimensionOrder.indexOf(targetName);
            
            userDimensionOrder.splice(fromIndex, 1);
            userDimensionOrder.splice(toIndex, 0, draggedDimensionItem);
            
            renderDimensionList();
            updateVisualization();
        }
        
        
        
        
        function handlePointDragStart(e, rowIndex) {
            draggedRowIndex = rowIndex;
            draggedDataPoint = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', rowIndex);
            
            
            hideTooltip();
        }
        
        function handlePointDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedDataPoint = null;
            draggedRowIndex = null;
            
            
            document.querySelectorAll('.inner-cell').forEach(cell => {
                cell.classList.remove('drop-target');
            });
        }
        
        function handleCellDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleCellDragEnter(e) {
            if (draggedRowIndex !== null) {
                const cell = e.target.closest('.inner-cell');
                if (cell) {
                    cell.classList.add('drop-target');
                }
            }
        }
        
        function handleCellDragLeave(e) {
            const cell = e.target.closest('.inner-cell');
            if (cell && !cell.contains(e.relatedTarget)) {
                cell.classList.remove('drop-target');
            }
        }
        
        function handleCellDrop(e, panelXVal, panelYVal, innerXVal, innerYVal) {
            e.preventDefault();
            
            const cell = e.target.closest('.inner-cell');
            if (cell) {
                cell.classList.remove('drop-target');
            }
            
            if (draggedRowIndex === null) return;
            
            const row = currentData[draggedRowIndex];
            if (!row) return;
            
            
            let changed = false;
            
            if (encodings.panelX && row[encodings.panelX.name] !== panelXVal) {
                row[encodings.panelX.name] = panelXVal;
                changed = true;
            }
            if (encodings.panelY && row[encodings.panelY.name] !== panelYVal) {
                row[encodings.panelY.name] = panelYVal;
                changed = true;
            }
            if (encodings.innerX && row[encodings.innerX.name] !== innerXVal) {
                row[encodings.innerX.name] = innerXVal;
                changed = true;
            }
            if (encodings.innerY && row[encodings.innerY.name] !== innerYVal) {
                row[encodings.innerY.name] = innerYVal;
                changed = true;
            }
            
            if (changed) {
                modifiedRows.add(draggedRowIndex);
                updateChangesIndicator();
                updateVisualization();
            }
        }
        
        
        
        
        function showContextMenu(e, rowIndex) {
            e.preventDefault();
            
            if (!encodings.color) {
                return; 
            }
            
            contextMenuRowIndex = rowIndex;
            const menu = document.getElementById('contextMenu');
            const grid = document.getElementById('colorGrid');
            const label = document.getElementById('colorLabel');
            
            const row = currentData[rowIndex];
            const currentValue = row[encodings.color.name];
            
            
            grid.innerHTML = '';
            encodings.color.uniqueValues.forEach((value, idx) => {
                const option = document.createElement('div');
                option.className = `color-option ${value === currentValue ? 'selected' : ''}`;
                option.style.backgroundColor = COLORS[idx % COLORS.length];
                option.title = value;
                option.onclick = () => changeColor(value);
                grid.appendChild(option);
            });
            
            label.textContent = `Current: ${currentValue}`;
            
            
            const x = Math.min(e.clientX, window.innerWidth - 200);
            const y = Math.min(e.clientY, window.innerHeight - 200);
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('visible');
        }
        
        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('visible');
            contextMenuRowIndex = null;
        }
        
        function changeColor(newValue) {
            if (contextMenuRowIndex === null || !encodings.color) return;
            
            const row = currentData[contextMenuRowIndex];
            const oldValue = row[encodings.color.name];
            
            if (oldValue !== newValue) {
                row[encodings.color.name] = newValue;
                modifiedRows.add(contextMenuRowIndex);
                updateChangesIndicator();
                updateVisualization();
            }
            
            closeContextMenu();
        }
        
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu') && !e.target.closest('.data-point')) {
                closeContextMenu();
            }
        });
        
        
        
        
        function renderDimensionList() {
            const list = document.getElementById('dimensionList');
            list.innerHTML = '';
            
            userDimensionOrder.forEach((name, idx) => {
                const dim = allDimensions.find(d => d.name === name);
                if (!dim) return;
                
                const isEnabled = enabledDimensions.has(name);
                const activeIndex = getActiveDimensions().findIndex(d => d.name === name);
                const encoding = activeIndex >= 0 ? ENCODING_LABELS[activeIndex] : null;
                
                const li = document.createElement('li');
                li.className = `dimension-item ${isEnabled ? '' : 'disabled'}`;
                li.draggable = true;
                li.dataset.name = name;
                
                li.innerHTML = `
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <input type="checkbox" class="dimension-toggle" 
                           ${isEnabled ? 'checked' : ''} 
                           onchange="toggleDimension('${name}', this.checked)">
                    <div class="dimension-rank">${activeIndex >= 0 ? activeIndex + 1 : '-'}</div>
                    <div class="dimension-info">
                        <div class="dimension-name">${dim.name}</div>
                        <div class="dimension-meta">${dim.cardinality} values</div>
                    </div>
                    ${encoding ? `<div class="dimension-encoding ${encoding.class}">${encoding.label}</div>` : ''}
                `;
                
                li.addEventListener('dragstart', (e) => handleDimDragStart(e, name));
                li.addEventListener('dragend', handleDimDragEnd);
                li.addEventListener('dragover', handleDimDragOver);
                li.addEventListener('dragenter', (e) => handleDimDragEnter(e, name));
                li.addEventListener('dragleave', handleDimDragLeave);
                li.addEventListener('drop', (e) => handleDimDrop(e, name));
                
                list.appendChild(li);
            });
            
            document.getElementById('dimensionSection').style.display = 'block';
        }
        
        function updateDimensionListEncodings() {
            const activeDims = getActiveDimensions();
            
            document.querySelectorAll('.dimension-item').forEach(item => {
                const name = item.dataset.name;
                const activeIndex = activeDims.findIndex(d => d.name === name);
                const isEnabled = enabledDimensions.has(name);
                
                const rankEl = item.querySelector('.dimension-rank');
                rankEl.textContent = activeIndex >= 0 ? activeIndex + 1 : '-';
                
                const existingEncoding = item.querySelector('.dimension-encoding');
                if (existingEncoding) existingEncoding.remove();
                
                if (activeIndex >= 0 && ENCODING_LABELS[activeIndex]) {
                    const encoding = ENCODING_LABELS[activeIndex];
                    const encodingEl = document.createElement('div');
                    encodingEl.className = `dimension-encoding ${encoding.class}`;
                    encodingEl.textContent = encoding.label;
                    item.appendChild(encodingEl);
                }
                
                item.classList.toggle('disabled', !isEnabled);
            });
        }
        
        function updateGridInfo(encodings) {
            const gridInfo = document.getElementById('gridInfo');
            const panelCols = encodings.panelX?.cardinality || 1;
            const panelRows = encodings.panelY?.cardinality || 1;
            const innerCols = encodings.innerX?.cardinality || 1;
            const innerRows = encodings.innerY?.cardinality || 1;
            
            gridInfo.innerHTML = `
                <div class="grid-info-row">
                    <span class="grid-info-label">Panel Grid:</span>
                    <span class="grid-info-value">${panelCols} √ó ${panelRows}</span>
                </div>
                <div class="grid-info-row">
                    <span class="grid-info-label">Inner Grid:</span>
                    <span class="grid-info-value">${innerCols} √ó ${innerRows}</span>
                </div>
            `;
        }
        
        function updateColorLegend(encodings) {
            const container = document.getElementById('colorLegend');
            const section = document.getElementById('legendSection');
            
            if (!encodings.color) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = '';
            
            encodings.color.uniqueValues.forEach((value, idx) => {
                const row = document.createElement('div');
                row.className = 'legend-row';
                row.innerHTML = `
                    <div class="legend-swatch" style="background: ${COLORS[idx % COLORS.length]}"></div>
                    <span>${value}</span>
                `;
                container.appendChild(row);
            });
        }
        
        function updateShapeLegend(encodings) {
            const container = document.getElementById('shapeLegend');
            const section = document.getElementById('shapeLegendSection');
            
            if (!encodings.shape) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = '';
            
            encodings.shape.uniqueValues.forEach((value, idx) => {
                const shape = SHAPES[idx % SHAPES.length];
                const row = document.createElement('div');
                row.className = 'legend-row';
                row.innerHTML = `
                    <div class="legend-shape">
                        <div class="data-point shape-${shape}" style="background: #888; width: 10px; height: 10px;"></div>
                    </div>
                    <span>${value}</span>
                `;
                container.appendChild(row);
            });
        }
        
        function updateFloatingLegend(encodings) {
            const content = document.getElementById('floatingLegendContent');
            let html = '';
            
            if (encodings && encodings.color) {
                html += `<div style="margin-bottom: 8px;"><strong style="font-size: 0.65rem; color: #888;">${encodings.color.name}</strong></div>`;
                encodings.color.uniqueValues.forEach((value, idx) => {
                    html += `
                        <div class="legend-row">
                            <div class="legend-swatch" style="background: ${COLORS[idx % COLORS.length]}"></div>
                            <span>${value}</span>
                        </div>
                    `;
                });
            }
            
            content.innerHTML = html;
        }
        
        
        
        
        function renderVisualization(data, encodings) {
            const container = document.getElementById('vizContainer');
            
            const mediaCount = data.filter(row => row.media_type && row.media_url).length;
            const activeDims = getActiveDimensions();
            
            document.getElementById('vizHeader').style.display = 'flex';
            document.getElementById('vizTitle').textContent = 'Data Editor';
            document.getElementById('vizStats').textContent = 
                `${data.length} records ‚Ä¢ ${modifiedRows.size} modified`;
            
            const panelXValues = encodings.panelX?.uniqueValues || ['All'];
            const panelYValues = encodings.panelY?.uniqueValues || ['All'];
            
            const panelCols = panelXValues.length;
            const panelRows = panelYValues.length;
            
            const grid = document.createElement('div');
            grid.className = 'panel-grid';
            grid.style.gridTemplateColumns = `40px repeat(${panelCols}, minmax(100px, 1fr))`;
            grid.style.gridTemplateRows = `30px repeat(${panelRows}, auto)`;
            
            
            grid.appendChild(createCell(''));
            
            
            panelXValues.forEach(val => {
                const cell = document.createElement('div');
                cell.className = 'panel-col-label';
                cell.textContent = val;
                cell.title = `${encodings.panelX?.name}: ${val}`;
                grid.appendChild(cell);
            });
            
            
            panelYValues.forEach(yVal => {
                const rowLabel = document.createElement('div');
                rowLabel.className = 'panel-row-label';
                rowLabel.textContent = yVal;
                rowLabel.title = `${encodings.panelY?.name}: ${yVal}`;
                grid.appendChild(rowLabel);
                
                panelXValues.forEach(xVal => {
                    const panel = createPanel(data, encodings, xVal, yVal);
                    grid.appendChild(panel);
                });
            });
            
            container.innerHTML = '';
            container.appendChild(grid);
        }
        
        function createCell(content) {
            const cell = document.createElement('div');
            cell.textContent = content;
            return cell;
        }
        
        function createPanel(data, encodings, panelXVal, panelYVal) {
            const panel = document.createElement('div');
            panel.className = 'panel';
            
            let panelData = data;
            
            if (encodings.panelX) {
                panelData = panelData.filter(row => row[encodings.panelX.name] === panelXVal);
            }
            if (encodings.panelY) {
                panelData = panelData.filter(row => row[encodings.panelY.name] === panelYVal);
            }
            
            const title = document.createElement('div');
            title.className = 'panel-title';
            title.textContent = `${panelData.length} items`;
            panel.appendChild(title);
            
            const innerXValues = encodings.innerX?.uniqueValues || ['All'];
            const innerYValues = encodings.innerY?.uniqueValues || ['All'];
            
            const innerCols = innerXValues.length;
            const innerRows = innerYValues.length;
            
            const innerGrid = document.createElement('div');
            innerGrid.className = 'inner-grid';
            innerGrid.style.gridTemplateColumns = `20px repeat(${innerCols}, 1fr)`;
            innerGrid.style.gridTemplateRows = `16px repeat(${innerRows}, 1fr)`;
            
            
            const corner = document.createElement('div');
            corner.className = 'corner-cell';
            innerGrid.appendChild(corner);
            
            
            innerXValues.forEach(xVal => {
                const header = document.createElement('div');
                header.className = 'inner-axis-label x-header';
                header.textContent = xVal;
                header.title = `${encodings.innerX?.name}: ${xVal}`;
                innerGrid.appendChild(header);
            });
            
            
            innerYValues.slice().reverse().forEach(yVal => {
                const yHeader = document.createElement('div');
                yHeader.className = 'inner-axis-label y-header';
                yHeader.textContent = yVal;
                yHeader.title = `${encodings.innerY?.name}: ${yVal}`;
                innerGrid.appendChild(yHeader);
                
                innerXValues.forEach(xVal => {
                    const cell = createInnerCell(panelData, encodings, panelXVal, panelYVal, xVal, yVal, innerXValues, innerYValues);
                    innerGrid.appendChild(cell);
                });
            });
            
            panel.appendChild(innerGrid);
            
            
            if (encodings.innerX || encodings.innerY) {
                const axisLabels = document.createElement('div');
                axisLabels.className = 'panel-axis-labels';
                
                if (encodings.innerY) {
                    axisLabels.innerHTML += `<span class="panel-axis-label">Y: ${encodings.innerY.name}</span>`;
                }
                if (encodings.innerX) {
                    axisLabels.innerHTML += `<span class="panel-axis-label">X: ${encodings.innerX.name}</span>`;
                }
                
                panel.appendChild(axisLabels);
            }
            
            return panel;
        }
        
        function createInnerCell(panelData, encodings, panelXVal, panelYVal, innerXVal, innerYVal, allInnerXVals, allInnerYVals) {
            const cell = document.createElement('div');
            cell.className = 'inner-cell';
            
            let cellData = panelData;
            
            if (encodings.innerX && allInnerXVals.length > 1) {
                cellData = cellData.filter(row => row[encodings.innerX.name] === innerXVal);
            }
            if (encodings.innerY && allInnerYVals.length > 1) {
                cellData = cellData.filter(row => row[encodings.innerY.name] === innerYVal);
            }
            
            
            cell.addEventListener('dragover', handleCellDragOver);
            cell.addEventListener('dragenter', handleCellDragEnter);
            cell.addEventListener('dragleave', handleCellDragLeave);
            cell.addEventListener('drop', (e) => handleCellDrop(e, panelXVal, panelYVal, innerXVal, innerYVal));
            
            cellData.forEach(row => {
                const point = createDataPoint(row, encodings);
                cell.appendChild(point);
            });
            
            return cell;
        }
        
        function createDataPoint(row, encodings) {
            const point = document.createElement('div');
            point.className = 'data-point';
            point.draggable = true;
            
            const rowIndex = row._index;
            const isModified = modifiedRows.has(rowIndex);
            
            if (isModified) {
                point.classList.add('modified');
            }
            
            const hasMedia = row.media_type && row.media_url;
            if (hasMedia) {
                point.classList.add('has-media');
            }
            
            
            if (encodings.color) {
                const colorIdx = encodings.color.uniqueValues.indexOf(row[encodings.color.name]);
                point.style.backgroundColor = COLORS[colorIdx % COLORS.length];
            } else {
                point.style.backgroundColor = COLORS[0];
            }
            
            
            if (encodings.shape) {
                const shapeIdx = encodings.shape.uniqueValues.indexOf(row[encodings.shape.name]);
                point.classList.add(`shape-${SHAPES[shapeIdx % SHAPES.length]}`);
            } else {
                point.classList.add('shape-circle');
            }
            
            
            point.addEventListener('dragstart', (e) => handlePointDragStart(e, rowIndex));
            point.addEventListener('dragend', handlePointDragEnd);
            
            
            point.addEventListener('mouseenter', (e) => showTooltip(e, row, hasMedia, isModified));
            point.addEventListener('mouseleave', hideTooltip);
            point.addEventListener('mousemove', moveTooltip);
            
            
            point.addEventListener('click', () => openModal(row, encodings));
            
            
            point.addEventListener('contextmenu', (e) => showContextMenu(e, rowIndex));
            
            return point;
        }
        
        
        
        
        function showTooltip(e, row, hasMedia, isModified) {
            const tooltip = document.getElementById('tooltip');
            
            const displayFields = Object.keys(row)
                .filter(k => !k.startsWith('_') && !RESERVED_COLUMNS.includes(k.toLowerCase()))
                .slice(0, 5);
            
            let html = displayFields.map(key => 
                `<strong>${key}:</strong> ${row[key]}`
            ).join('<br>');
            
            if (isModified) {
                html += `<div style="color: #ffd93d; margin-top: 6px; font-size: 0.7rem;">‚ö†Ô∏è Modified</div>`;
            }
            
            html += `<div class="tooltip-hint">`;
            if (hasMedia) {
                const mediaIcon = row.media_type === 'video' ? 'üé¨' : 
                                  row.media_type === 'audio' ? 'üéµ' : 'üì∑';
                html += `${mediaIcon} Click to view ‚Ä¢ `;
            }
            html += `Drag to move ‚Ä¢ Right-click for color</div>`;
            
            tooltip.innerHTML = html;
            tooltip.classList.add('visible');
            moveTooltip(e);
        }
        
        function moveTooltip(e) {
            const tooltip = document.getElementById('tooltip');
            const x = e.clientX + 15;
            const y = e.clientY + 15;
            
            const rect = tooltip.getBoundingClientRect();
            const maxX = window.innerWidth - rect.width - 20;
            const maxY = window.innerHeight - rect.height - 20;
            
            tooltip.style.left = `${Math.min(x, maxX)}px`;
            tooltip.style.top = `${Math.min(y, maxY)}px`;
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }
        
        
        
        
        function openModal(row, encodings) {
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalTitle');
            
            const titleField = row.title || row.name || row.Name || row.Title || `Record #${row._index + 1}`;
            modalTitle.textContent = titleField;
            
            let tableHTML = '<table class="data-table">';
            
            Object.keys(row).forEach(key => {
                if (key.startsWith('_')) return;
                if (RESERVED_COLUMNS.some(rc => key.toLowerCase() === rc)) return;
                
                let valueHTML = row[key];
                
                if (encodings.color && key === encodings.color.name) {
                    const colorIdx = encodings.color.uniqueValues.indexOf(row[key]);
                    const color = COLORS[colorIdx % COLORS.length];
                    valueHTML = `<span class="data-tag" style="background: ${color}33; color: ${color}">${row[key]}</span>`;
                }
                
                tableHTML += `
                    <tr>
                        <td>${key}</td>
                        <td>${valueHTML}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</table>';
            
            const hasMedia = row.media_type && row.media_url;
            
            if (hasMedia) {
                const mediaIcon = row.media_type === 'video' ? 'üé¨' : 
                                  row.media_type === 'audio' ? 'üéµ' : 'üì∑';
                const mediaLabel = row.media_type.charAt(0).toUpperCase() + row.media_type.slice(1);
                
                tableHTML += `
                    <div class="media-section">
                        <div class="media-section-title">
                            <span class="icon">${mediaIcon}</span>
                            ${mediaLabel} Content
                        </div>
                        <div class="media-container ${row.media_type === 'audio' ? 'audio-container' : ''}">
                            ${generateMediaHTML(row)}
                        </div>
                    </div>
                `;
            }
            
            modalBody.innerHTML = tableHTML;
            document.getElementById('modalOverlay').classList.add('active');
        }
        
        function generateMediaHTML(row) {
            switch (row.media_type) {
                case 'image':
                    return `<img src="${row.media_url}" alt="${row.title || 'Image'}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22250%22><rect fill=%22%23333%22 width=%22100%%22 height=%22100%%22/><text x=%2250%%22 y=%2250%%22 fill=%22%23666%22 text-anchor=%22middle%22>Image unavailable</text></svg>'">`;
                case 'video':
                    return `<video controls autoplay muted><source src="${row.media_url}" type="video/mp4"></video>`;
                case 'audio':
                    return `<div class="audio-icon">üéµ</div><audio controls autoplay><source src="${row.media_url}" type="audio/wav"><source src="${row.media_url}" type="audio/mpeg"></audio>`;
                default:
                    return `<div class="no-media">Unknown media type</div>`;
            }
        }
        
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modalOverlay').classList.remove('active');
            document.querySelectorAll('video, audio').forEach(el => {
                el.pause();
                el.currentTime = 0;
            });
        }
        
        
        
        
        const fileDrop = document.getElementById('fileDrop');
        const fileInput = document.getElementById('fileInput');
        
        fileDrop.addEventListener('click', () => fileInput.click());
        
        fileDrop.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDrop.classList.add('dragover');
        });
        
        fileDrop.addEventListener('dragleave', () => {
            fileDrop.classList.remove('dragover');
        });
        
        fileDrop.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDrop.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                loadFile(file);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadFile(file);
            }
        });
        
        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                processCSV(e.target.result);
            };
            reader.readAsText(file);
        }
        
        function processCSV(text) {
            const { headers, data } = parseCSV(text);
            
            
            originalData = JSON.parse(JSON.stringify(data));
            currentData = data;
            modifiedRows.clear();
            
            allDimensions = analyzeDimensions(headers, data);
            userDimensionOrder = allDimensions.map(d => d.name);
            enabledDimensions = new Set(userDimensionOrder);
            
            renderDimensionList();
            updateChangesIndicator();
            updateVisualization();
        }
        
        
        
        
        function loadSampleData() {
            const sampleCSV = `ID,Function,Intonation,Focus,Canonical,Surprise,media_type,media_url
1,Genuine,Rising,0,0,0,audio,/kourosh/01_00_10_Genuine.wav
2,Offer,Rising,0,0,0,audio,/kourosh/01_00_2_Offer.wav
3,Rhetorical,Rising,1,0,1,audio,/kourosh/02_20_4_Rhetorical.wav
4,Offer,Rising,0,1,0,audio,/kourosh/02_20_6_Offer.wav
5,Confirmation,Rising,0,0,1,audio,/kourosh/02_20_8_Confirmation.wav
6,Confirmation,Rising,0,0,0,audio,/kourosh/02_50_2_Confirmation.wav
7,Genuine,Neutral,0,1,0,audio,/kourosh/02_50_6_Genuine.wav
8,Genuine,Rising,0,1,1,audio,/kourosh/03_27_8_Genuine.wav
9,Confirmation,Rising,1,1,1,audio,/kourosh/05_15_4_Confirmation.wav
11,Genuine,Rising,0,1,0,audio,/kourosh/06_15_4_Genuine.wav
13,Genuine,Neutral,0,1,0,audio,/kourosh/07_26_10_Genuine.wav
14,Confirmation,Rising,1,1,1,audio,/kourosh/07_26_4_Confirmation.wav
15,Echo,Rising,0,1,0,audio,/kourosh/07_55_4_Echo.wav
16,Echo,Rising,1,1,1,audio,/kourosh/09_01_2_Echo.wav
17,Offer,Neutral,0,0,0,audio,/kourosh/09_01_4_Offer.wav
18,Confirmation,Neutral,1,0,0,audio,/kourosh/09_10_2_Confirmation.wav
19,Genuine,Rising,0,1,0,audio,/kourosh/10_00_4_Genuine.wav
20,Echo,Rising,0,1,0,audio,/kourosh/10_00_8_Echo.wav
21,Confirmation,Rising,0,1,0,audio,/kourosh/10_07_10_Confirmation.wav
22,Echo,Rising,1,1,1,audio,/kourosh/10_07_2_Echo.wav
23,Genuine,Rising,0,0,0,audio,/kourosh/10_07_8_Genuine.wav
24,Genuine,Rising,1,0,0,audio,/kourosh/11_29_2_Genuine.wav
25,Rhetorical,Neutral,0,1,0,audio,/kourosh/11_29_4_Rhetorical.wav
26,Confirmation,Rising,0,1,0,audio,/kourosh/13_59_10_Confirmation.wav
27,Request,Rising,0,1,0,audio,/kourosh/13_59_4_Request.wav
28,Genuine,Rising,1,1,0,audio,/kourosh/14_21_10_Genuine.wav
29,Confirmation,Rising,0,1,0,audio,/kourosh/14_21_12_Confirmation.wav
30,Confirmation,Neutral,1,0,0,audio,/kourosh/14_21_14_Confirmation.wav
31,Request,Rising,0,0,0,audio,/kourosh/14_21_8_Request.wav
33,Confirmation,Rising,0,1,0,audio,/kourosh/15_21_4_Confirmation.wav
34,Confirmation,Rising,1,1,1,audio,/kourosh/16_05_4_Confirmation.wav
35,Confirmation,Neutral,0,1,0,audio,/kourosh/16_20_10_Confirmation.wav
36,Echo,Rising,0,1,0,audio,/kourosh/16_20_14_Echo.wav
37,Confirmation,Rising,1,1,1,audio,/kourosh/16_20_2_Confirmation.wav
38,Rhetorical,Rising,0,0,0,audio,/kourosh/16_20_4_Rhetorical.wav
39,Confirmation,Rising,1,0,1,audio,/kourosh/16_20_6_Confirmation.wav
40,Genuine,Rising,0,1,0,audio,/kourosh/16_20_8_Genuine.wav
41,Request,Rising,0,0,0,audio,/kourosh/17_00_8_Request.wav
42,Request,Rising,1,1,1,audio,/kourosh/17_30_10_Request.wav
43,Confirmation,Rising,0,1,0,audio,/kourosh/17_30_4_Confirmation.wav
44,Confirmation,Rising,1,0,1,audio,/kourosh/17_55_2_Confirmation.wav
45,Echo,Rising,1,0,1,audio,/kourosh/17_55_4_Echo.wav
46,Genuine,Rising,0,1,0,audio,/kourosh/19_54_10_Genuine.wav
47,Genuine,Rising,0,0,0,audio,/kourosh/19_54_14_Genuine.wav
48,Confirmation,Rising,0,1,0,audio,/kourosh/19_54_2_Confirmation.wav
49,Request,Neutral,0,1,0,audio,/kourosh/19_54_4_Request.wav
50,Confirmation,Rising,0,1,0,audio,/kourosh/19_54_6_Confirmation.wav
51,Rhetorical,Rising,0,0,1,audio,/kourosh/20_57_2_Rhetorical.wav
52,Genuine,Neutral,0,1,0,audio,/kourosh/20_57_4_Genuine.wav
53,Echo,Rising,0,0,1,audio,/kourosh/36_59_10_Echo.wav
54,Confirmation,Rising,0,1,0,audio,/kourosh/36_59_12_Confirmation.wav
55,Echo,Rising,0,1,1,audio,/kourosh/36_59_4_Echo.wav
56,Echo,Rising,0,1,1,audio,/kourosh/36_59_6_Echo.wav
57,Rhetorical,Rising,0,0,1,audio,/kourosh/36_59_8_Rhetorical.wav
58,Offer,Rising,0,0,0,audio,/kourosh/38_27_2_Offer.wav
59,Offer,Rising,0,0,0,audio,/kourosh/38_27_6_Offer.wav
60,Offer,Rising,0,1,0,audio,/kourosh/39_50_2_Offer.wav
61,Request,Rising,0,1,0,audio,/kourosh/39_50_8_Request.wav
62,Confirmation,Rising,1,1,1,audio,/kourosh/43_45_4_Confirmation.wav
63,Confirmation,Rising,1,0,1,audio,/kourosh/44_45_2_Confirmation.wav
64,Offer,Neutral,0,1,0,audio,/kourosh/44_45_8_Offer.wav`;
            
            processCSV(sampleCSV);
        }
    </script>
</body>
</html>